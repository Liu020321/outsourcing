<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8"/>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>查看处理结果</title>

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Favicon -->
    <link rel="shortcut icon" th:href="@{images/favicon.ico}"/>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{css/bootstrap.min.css}"/>
    <!-- Typography CSS -->
    <link rel="stylesheet" th:href="@{css/typography.css}"/>
    <!-- Style CSS -->
    <link rel="stylesheet" th:href="@{css/style.css}"/>
    <!-- Responsive CSS -->
    <link rel="stylesheet" th:href="@{css/responsive.css}"/>
</head>
<body>
<!-- loader Start -->
<div id="loading">
    <div id="loading-center"></div>
</div>
<!-- loader END -->
<!-- Wrapper Start -->
<div class="wrapper">
    <!-- Sidebar  -->
    <div
            th:replace="~{commons/commons::sidebar(active1='yiliao',active2='viewresult.html')}"
    ></div>
    <!-- TOP Nav Bar -->
    <div th:replace="~{commons/commons::topnavbar}"></div>
    <!-- TOP Nav Bar END -->
    <!-- Responsive Breadcrumb End-->
    <!-- Page Content  -->
    <div id="content-page" class="content-page">
        <div class="container-fluid" id="result">
            <div class="row">
                <div class="col-sm-12">
                    <div class="iq-card">
                        <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title">
                                <h4 class="card-title">图像列表</h4>
                            </div>
                        </div>
                        <div class="iq-card-body">
                            <div class="table-responsive">
                                <div class="row justify-content-between">
                                    <div class="col-sm-12 col-md-6">
                                        <div
                                                id="user_list_datatable_info"
                                                class="dataTables_filter"
                                        >
                                            <form class="mr-3 position-relative" @submit.prevent="searchViewResult">
                                                <div class="form-group mb-0 ">
                                                    <input
                                                            type="Search"
                                                            class="form-control"
                                                            id="exampleInputSearch"
                                                            placeholder="搜索..."
                                                            aria-controls="user-list-table"
                                                            v-model="searchName"
                                                    />
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    <!--<div class="col-sm-12 col-md-6">
                                                      <div class="user-list-files d-flex float-right">
                                                          <a class="iq-bg-primary" href="javascript:void();" >
                                                              Print
                                                          </a>
                                                          <a class="iq-bg-primary" href="javascript:void();">
                                                              Excel
                                                          </a>
                                                          <a class="iq-bg-primary" href="javascript:void();">
                                                              Pdf
                                                          </a>
                                                      </div>
                                                  </div>-->
                                </div>
                                <table
                                        id="user-list-table"
                                        class="table table-striped table-bordered mt-4"
                                        role="grid"
                                        aria-describedby="user-list-page-info"
                                >
                                    <thead>
                                    <tr>
                                        <th>患者姓名</th>
                                        <th>文件名称</th>
                                        <th>文件格式</th>
                                        <th>检查日期</th>
                                        <th>描述</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr v-for="(item, index) in products" :key="index">
                                        <td>{{ item.name }}</td>
                                        <td>
                                            {{ getFileNameWithoutExtension(item.fileName).name
                                            }}
                                        </td>
                                        <td>
                            <span class="badge iq-bg-primary"
                            >{{
                                    getFileNameWithoutExtension(item.fileName).type
                                }}</span
                            >
                                        </td>
                                        <td>{{ item.date }}</td>
                                        <td>{{ item.describe }}</td>
                                        <td>
                                            <div
                                                    class="flex align-items-center list-user-action"
                                            >
                                                <a
                                                        class="iq-bg-primary"
                                                        data-toggle="tooltip"
                                                        data-placement="top"
                                                        title=""
                                                        data-original-title="查看图像"
                                                        href="#"
                                                        @click="redirectToImage(item.fileName)"
                                                ><i class="ri-user-add-line"></i
                                                ></a>
<!--                                                <a-->
<!--                                                        class="iq-bg-primary"-->
<!--                                                        data-toggle="tooltip"-->
<!--                                                        data-placement="top"-->
<!--                                                        title=""-->
<!--                                                        data-original-title="处理图像"-->
<!--                                                        href="#"-->
<!--                                                ><i class="ri-pencil-line"></i-->
<!--                                                ></a>-->
                                                <a
                                                        class="iq-bg-primary"
                                                        data-toggle="tooltip"
                                                        data-placement="top"
                                                        title=""
                                                        data-original-title="删除图像"
                                                        @click="deleteViewResult(item.id);deleteFile(item.fileName)"
                                                        href="#"
                                                ><i class="ri-delete-bin-line"></i
                                                ></a>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="row justify-content-between mt-3">
                                <div id="user-list-page-info" class="col-md-6">
                                    <span>共有1-{{totalPages}}页</span>
                                </div>
                                <div class="col-md-6">
                                    <nav aria-label="Page navigation example">
                                        <ul class="pagination justify-content-end mb-0">
                                            <li
                                                    class="page-item"
                                                    :class="{ 'disabled': currentPage === 1 }"
                                            >
                                                <a class="page-link" href="#" @click="prevPage"
                                                >Previous</a
                                                >
                                            </li>
                                            <li
                                                    class="page-item"
                                                    v-for="pageNumber in totalPages"
                                                    :key="pageNumber"
                                                    :class="{ 'active': currentPage === pageNumber }"
                                            >
                                                <a
                                                        class="page-link"
                                                        href="#"
                                                        @click="goToPage(pageNumber)"
                                                >{{ pageNumber }}</a
                                                >
                                            </li>
                                            <li
                                                    class="page-item"
                                                    :class="{ 'disabled': currentPage === totalPages }"
                                            >
                                                <a class="page-link" href="#" @click="nextPage"
                                                >Next</a
                                                >
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Wrapper END -->
<!-- Footer -->
<div th:replace="~{commons/commons::footer}"></div>
<!-- Footer END -->
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->

<div th:replace="~{commons/commons::js}"></div>

<script>
    new Vue({
        el: '#result',
        data() {
            return {
                deleteId: '',
                searchName: '',
                products: {
                    id: '',
                    name: '', // 修正为fileNames
                    fileName: '',
                    date: '',
                    describe: '',
                },
                currentPage: 1,
                pageSize: 7,
                totalPages: 0,
            };
        },
        mounted() {
            this.loadProducts();
        },
        methods: {
            loadProducts() {
                axios
                    .get(
                        `/api/products1?page=${this.currentPage}&size=${this.pageSize}`
                    )
                    .then((response) => {
                        this.products = response.data.rows;
                        this.totalPages = response.data.totalPages;
                    })
                    .catch((error) => {
                        console.error(error);
                    });
            },
            prevPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.loadProducts();
                }
            },
            nextPage() {
                if (this.currentPage < this.totalPages) {
                    this.currentPage++;
                    this.loadProducts();
                }
            },
            goToPage(pageNumber) {
                if (pageNumber >= 1 && pageNumber <= this.totalPages) {
                    this.currentPage = pageNumber;
                    this.loadProducts();
                }
            },
            deleteFile(fileName) {
                if (this.getFileNameWithoutExtension(fileName).type === '.nii.gz') {
                    axios({
                        method: 'post',
                        url: 'http://localhost:8081/api/deleteFile?fileName=' + fileName,
                    })
                        .then((resp) => {
                            if (resp.status === 200) {
                                console.log('success delete fileName: ' + fileName);
                            }
                        })
                        .catch((error) => {
                            console.error('Error deleting file:', error);
                        });
                }else {
                    console.log('not delete fileName: ' + fileName)
                }
            },
            getFileNameWithoutExtension(fileName) {
                const name = fileName.split('.')[0];
                const type = fileName.substring(name.length);
                return {
                    name: name,
                    type: type,
                };
            },
            redirectToImage(imageId) {
                axios({
                    method: 'post',
                    url: 'http://localhost:8081/redirect/?imageId=' + imageId,
                }).then((resp) => {
                    if (resp.data === 'success') {
                        if (this.getFileNameWithoutExtension(imageId).type === '.nii.gz') {
                            window.location.href =
                                'http://localhost:8081/viewNfi?imageId=' + imageId;
                        } else if (
                            this.getFileNameWithoutExtension(imageId).type === '.dcm'
                        ) {
                            window.location.href =
                                'http://localhost:8081/viewDicom?imageId=' + this.getFileNameWithoutExtension(imageId).name;
                        }
                    } else {
                        alert('跳转失败');
                    }
                });
            },
            getCombinedData(item) {
                const name = this.getFileNameWithoutExtension(item.fileName).name;
                const type = this.getFileNameWithoutExtension(item.fileName).type;
                return `${name}${type}`;
            },
            deleteViewResult(id) {
                this.deleteId = id;
                axios({
                    method: 'post',
                    url: 'http://localhost:8081/api/delete1?id=' + id,
                    data: this.deleteId,
                }).then((resp) => {
                    if (resp.data === 'success') {
                        alert('删除成功');
                        this.loadProducts();
                    } else {
                        alert('删除失败');
                    }
                });
            },
            searchViewResult() {
                axios({
                    method: 'post',
                    url:
                        'http://localhost:8081/api/search1?name=' +
                        this.searchName +
                        '&page=' +
                        this.currentPage +
                        '&size=' +
                        this.pageSize,
                    data: this.searchName,
                }).then((resp) => {
                    this.products = [];
                    this.products = resp.data;
                    alert('查询成功');
                });
            },
        },
    });
</script>
</body>
</html>
