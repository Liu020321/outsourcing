<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>查看处理结果</title>

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Favicon -->
    <link rel="shortcut icon" th:href="@{images/favicon.ico}" />
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{css/bootstrap.min.css}" />
    <!-- Typography CSS -->
    <link rel="stylesheet" th:href="@{css/typography.css}" />
    <!-- Style CSS -->
    <link rel="stylesheet" th:href="@{css/style.css}" />
    <!-- Responsive CSS -->
    <link rel="stylesheet" th:href="@{css/responsive.css}" />
  </head>
  <body>
    <!-- loader Start -->
    <div id="loading">
      <div id="loading-center"></div>
    </div>
    <!-- loader END -->
    <!-- Wrapper Start -->
    <div class="wrapper">
      <!-- Sidebar  -->
      <div
        th:replace="~{commons/commons::sidebar(active1='yiliao',active2='viewResult.html')}"
      ></div>
      <!-- TOP Nav Bar -->
      <div th:replace="~{commons/commons::topnavbar}"></div>
      <!-- TOP Nav Bar END -->
      <!-- Responsive Breadcrumb End-->
      <!-- Page Content  -->
      <div id="content-page" class="content-page">
        <div class="container-fluid" id="result">
          <div class="row">
            <div class="col-sm-12">
              <div class="iq-card">
                <div class="iq-card-header d-flex justify-content-between">
                  <div class="iq-header-title">
                    <h4 class="card-title">图像列表</h4>
                  </div>
                </div>
                <div class="iq-card-body">
                  <div class="table-responsive">
                    <div class="row justify-content-between">
                      <div class="col-sm-12 col-md-6">
                        <div
                          id="user_list_datatable_info"
                          class="dataTables_filter"
                        >
                          <form class="mr-3 position-relative">
                            <div class="form-group mb-0">
                              <input
                                type="search"
                                class="form-control"
                                id="exampleInputSearch"
                                placeholder="Search"
                                aria-controls="user-list-table"
                              />
                            </div>
                          </form>
                        </div>
                      </div>
                      <!--<div class="col-sm-12 col-md-6">
                                        <div class="user-list-files d-flex float-right">
                                            <a class="iq-bg-primary" href="javascript:void();" >
                                                Print
                                            </a>
                                            <a class="iq-bg-primary" href="javascript:void();">
                                                Excel
                                            </a>
                                            <a class="iq-bg-primary" href="javascript:void();">
                                                Pdf
                                            </a>
                                        </div>
                                    </div>-->
                    </div>
                    <table
                      id="user-list-table"
                      class="table table-striped table-bordered mt-4"
                      role="grid"
                      aria-describedby="user-list-page-info"
                    >
                      <thead>
                        <tr>
                          <th>患者姓名</th>
                          <th>文件名称</th>
                          <th>文件格式</th>
                          <th>检查日期</th>
                          <th>描述</th>
                          <th>操作</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr
                          v-for="(item, index) in products"
                          :key="index"
                        >
                          <td>{{ item.name }}</td>
                          <td>{{ getFileNameWithoutExtension(item.fileName).name }}</td>
                          <td>
                            <span class="badge iq-bg-primary"
                              >{{ getFileNameWithoutExtension(item.fileName).type
                              }}</span
                            >
                          </td>
                          <td>{{ item.date }}</td>
                          <td>{{ item.describe }}</td>
                          <td>
                            <div
                              class="flex align-items-center list-user-action"
                            >
                              <a
                                class="iq-bg-primary"
                                data-toggle="tooltip"
                                data-placement="top"
                                title=""
                                data-original-title="查看图像"
                                href="#"
                                @click="redirectToImage(item.fileName)"
                                ><i class="ri-user-add-line"></i
                              ></a>
                              <a
                                class="iq-bg-primary"
                                data-toggle="tooltip"
                                data-placement="top"
                                title=""
                                data-original-title="处理图像"
                                href="#"
                                ><i class="ri-pencil-line"></i
                              ></a>
                              <a
                                class="iq-bg-primary"
                                data-toggle="tooltip"
                                data-placement="top"
                                title=""
                                data-original-title="删除图像"
                                href="#"
                                ><i class="ri-delete-bin-line"></i
                              ></a>
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="row justify-content-between mt-3">
                    <div id="user-list-page-info" class="col-md-6">
                      <span>共有1-{{totalPages}}页</span>
                    </div>
                    <div class="col-md-6">
                      <nav aria-label="Page navigation example">
                        <ul class="pagination justify-content-end mb-0">
                          <li class="page-item" :class="{ 'disabled': currentPage === 1 }">
                            <a class="page-link" href="#" @click="prevPage">Previous</a>
                          </li>
                          <li class="page-item" v-for="pageNumber in totalPages" :key="pageNumber"
                              :class="{ 'active': currentPage === pageNumber }">
                            <a class="page-link" href="#" @click="goToPage(pageNumber)">{{ pageNumber }}</a>
                          </li>
                          <li class="page-item" :class="{ 'disabled': currentPage === totalPages }">
                            <a class="page-link" href="#" @click="nextPage">Next</a>
                          </li>
                        </ul>
                      </nav>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Wrapper END -->
    <!-- Footer -->
    <div th:replace="~{commons/commons::footer}"></div>
    <!-- Footer END -->
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->

    <div th:replace="~{commons/commons::js}"></div>

    <script>
      new Vue({
        el: '#result',
        data() {
          return {
            products:{
              id: '',
              name: '', // 修正为fileNames
              fileName: '',
              date: '',
              describe: '',
            },
            currentPage: 1,
            pageSize: 7,
            totalPages: 0,
          }
        },
        mounted() {
          this.loadProducts();
        },
        methods: {
          loadProducts() {
            axios.get(`/api/products?page=${this.currentPage}&size=${this.pageSize}`)
                    .then(response => {
                      this.products = response.data.rows;
                      this.totalPages = response.data.totalPages;
                    })
                    .catch(error => {
                      console.error(error);
                    });
          },
          prevPage() {
            if (this.currentPage > 1) {
              this.currentPage--;
              this.loadProducts();
            }
          },
          nextPage() {
            if (this.currentPage < this.totalPages) {
              this.currentPage++;
              this.loadProducts();
            }
          },
          goToPage(pageNumber) {
            if (pageNumber >= 1 && pageNumber <= this.totalPages) {
              this.currentPage = pageNumber;
              this.loadProducts();
            }
          },
          fetchFileNames() {
            axios
              .get('/files')
              .then((response) => {
                this.results.fileName = response.data; // 修正为fileNames
              })
              .catch((error) => {
                console.error(error);
              });
          },
          getFileNameWithoutExtension(fileName) {
            const name = fileName.split('.')[0];
            const type = fileName.substring(name.length);
            return {
              name: name,
              type: type,
            };
          },
          redirectToImage(imageId) {
            axios({
              method: 'post',
              url: 'http://localhost:8081/redirect/?imageId=' + imageId,
            }).then((resp) => {
              if (resp.data === 'success') {
                window.location.href =
                  'http://localhost:8081/viewNifti?imageId=' + imageId;
              } else {
                alert('跳转失败');
              }
            });
          },
          getCombinedData(item) {
            const name = this.getFileNameWithoutExtension(item.fileName).name;
            const type = this.getFileNameWithoutExtension(item.fileName).type;
            return `${name}${type}`;
          },
        },

      });
    </script>
  </body>
</html>
