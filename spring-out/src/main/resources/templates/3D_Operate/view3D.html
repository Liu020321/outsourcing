<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Vito - Responsive Bootstrap 4 Admin Dashboard Template</title>

    <!-- Favicon -->
    <link rel="shortcut icon" th:href="@{images/favicon.ico}" />
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{css/bootstrap.min.css}" />
    <!-- Typography CSS -->
    <link rel="stylesheet" th:href="@{css/typography.css}" />
    <!-- Style CSS -->
    <link rel="stylesheet" th:href="@{css/style.css}" />
    <!-- Responsive CSS -->
    <link rel="stylesheet" th:href="@{css/responsive.css}" />
    <style>
      .image-view {
        width: 300px;
        height: 300px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <!-- loader Start -->
    <div id="loading">
      <div id="loading-center"></div>
    </div>
    <!-- loader END -->
    <!-- Wrapper Start -->
    <div class="wrapper">
      <!-- Sidebar  -->
      <div th:replace="~{commons/commons::sidebar(active1='yiliao')}"></div>
      <!-- TOP Nav Bar -->
      <div th:replace="~{commons/commons::topnavbar}"></div>
      <!-- TOP Nav Bar END -->
      <!-- Responsive Breadcrumb End-->
      <!-- Page Content  -->

      <div id="content-page" class="content-page">
        <div class="container-fluid" id="result">
          <div class="row">
            <div class="col-sm-12">
              <div class="iq-card">
                <div class="iq-card-header d-flex justify-content-between">
                  <div class="iq-header-title">
                    <h4 class="card-title">图像展示</h4>
                  </div>
                </div>
                <div class="iq-card-body">
                  <div class="row">
                    <canvas id="axial-canvas" class="image-view"></canvas>
                    <canvas id="sagittal-canvas" class="image-view"></canvas>
                    <canvas id="coronal-canvas" class="image-view"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Wrapper END -->
    <!-- Footer -->
    <div th:replace="~{commons/commons::footer}"></div>
    <!-- Footer END -->
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <div th:replace="~{commons/commons::js}"></div>

    <script src="js/cornerstone/cornerstone.js"></script>
    <script src="js/cornerstone/cornerstoneMath.js"></script>
    <script src="js/cornerstone/cornerstoneTools.js"></script>
    <script src="js/cornerstone/cornerstoneFileImageLoader.js"></script>
    <script src="js/cornerstone/cornerstoneNIFTIImageLoader.js"></script>
    <script>
      cornerstoneNIFTIImageLoader.external.cornerstone = cornerstone;
      const ImageId = cornerstoneNIFTIImageLoader.nifti.ImageId;
      let loaded = false;

      window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const niftiName = urlParams.get('imageId');
        downloadAndView(niftiName);
      };

      // 获取三个视图的Canvas元素
      const axialElement = document.getElementById('axial-canvas');
      const sagittalElement = document.getElementById('sagittal-canvas');
      const coronalElement = document.getElementById('coronal-canvas');

      // 启用Cornerstone.js
      cornerstone.enable(axialElement);
      cornerstone.enable(sagittalElement);
      cornerstone.enable(coronalElement);

      function downloadAndView(niftiName) {
        let url = `/Files/${niftiName}`;

        loadAndViewImage(`nifti:${url}`);
      }

      function loadAndViewImage(imageId) {
        const element2 = document.getElementById('nifti-image2');
        const imageIdObject = ImageId.fromURL(imageId);

        try {
          cornerstone.loadAndCacheImage(imageIdObject.url).then(
            function (image) {
              console.log(image);
              const numberOfSlices = cornerstone.metaData.get(
                'multiFrameModule',
                imageIdObject.url
              ).numberOfFrames;
              const stack = {
                currentImageIdIndex: imageIdObject.slice.index,
                imageIds: Array.from(
                  Array(numberOfSlices),
                  (_, i) =>
                    `nifti:${imageIdObject.filePath}#${imageIdObject.slice.dimension}-${i}`
                ),
              };

              const axialViewport = cornerstone.getDefaultViewportForImage(
                axialElement,
                image
              );
              const sagittalViewport = cornerstone.getDefaultViewportForImage(
                sagittalElement,
                image
              );
              const coronalViewport = cornerstone.getDefaultViewportForImage(
                coronalElement,
                image
              );

              // 在每个视图中显示图像
              // 在每个视图的Canvas上显示图像
              cornerstone.displayImage(axialElement, image, axialViewport);
              cornerstone.displayImage(
                sagittalElement,
                image,
                sagittalViewport
              );
              cornerstone.displayImage(coronalElement, image, coronalViewport);

              if (loaded === false) {
                // 添加工具和功能到axial-view
                cornerstoneTools.addStackStateManager(axialElement, [
                  'stack',
                  'wwwc',
                  'pan',
                  'zoom',
                ]);
                cornerstoneTools.addToolState(axialElement, 'stack', stack);
                cornerstoneTools.mouseInput.enable(axialElement);
                cornerstoneTools.mouseWheelInput.enable(axialElement);
                cornerstoneTools.wwwc.activate(axialElement, 1);
                cornerstoneTools.pan.activate(axialElement, 2);
                cornerstoneTools.zoom.activate(axialElement, 4);
                cornerstoneTools.stackScrollWheel.activate(axialElement);
                cornerstoneTools.orientationMarkers.enable(axialElement);

                // 添加工具和功能到sagittal-view
                cornerstoneTools.addStackStateManager(sagittalElement, [
                  'stack',
                  'wwwc',
                  'pan',
                  'zoom',
                ]);
                cornerstoneTools.addToolState(sagittalElement, 'stack', stack);
                cornerstoneTools.mouseInput.enable(sagittalElement);
                cornerstoneTools.mouseWheelInput.enable(sagittalElement);
                cornerstoneTools.wwwc.activate(sagittalElement, 1);
                cornerstoneTools.pan.activate(sagittalElement, 2);
                cornerstoneTools.zoom.activate(sagittalElement, 4);
                cornerstoneTools.stackScrollWheel.activate(sagittalElement);
                cornerstoneTools.orientationMarkers.enable(sagittalElement);

                // 添加工具和功能到coronal-view
                cornerstoneTools.addStackStateManager(coronalElement, [
                  'stack',
                  'wwwc',
                  'pan',
                  'zoom',
                ]);
                cornerstoneTools.addToolState(coronalElement, 'stack', stack);
                cornerstoneTools.mouseInput.enable(coronalElement);
                cornerstoneTools.mouseWheelInput.enable(coronalElement);
                cornerstoneTools.wwwc.activate(coronalElement, 1);
                cornerstoneTools.pan.activate(coronalElement, 2);
                cornerstoneTools.zoom.activate(coronalElement, 4);
                cornerstoneTools.stackScrollWheel.activate(coronalElement);
                cornerstoneTools.orientationMarkers.enable(coronalElement);

                loaded = true;
              }
            },
            function (err) {
              alert(err);
              console.error(err);
            }
          );
        } catch (err) {
          alert(err);
          console.error(err);
        }
      }
    </script>
  </body>
</html>
