<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8"/>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Vito - Responsive Bootstrap 4 Admin Dashboard Template</title>

    <!-- Favicon -->
    <link rel="shortcut icon" th:href="@{images/favicon.ico}"/>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{css/bootstrap.min.css}"/>
    <!-- Typography CSS -->
    <link rel="stylesheet" th:href="@{css/typography.css}"/>
    <!-- Style CSS -->
    <link rel="stylesheet" th:href="@{css/style.css}"/>
    <!-- Responsive CSS -->
    <link rel="stylesheet" th:href="@{css/responsive.css}"/>
  <style>
    .image-view {
      width: 300px;
      height: 300px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
<!-- loader Start -->
<div id="loading">
    <div id="loading-center"></div>
</div>
<!-- loader END -->
<!-- Wrapper Start -->
<div class="wrapper">
    <!-- Sidebar  -->
    <div th:replace="~{commons/commons::sidebar(active1='yiliao')}"></div>
    <!-- TOP Nav Bar -->
    <div th:replace="~{commons/commons::topnavbar}"></div>
    <!-- TOP Nav Bar END -->
    <!-- Responsive Breadcrumb End-->
    <!-- Page Content  -->

    <div id="content-page" class="content-page">
        <div class="container-fluid" id="result">
            <div class="row">
                <div class="col-sm-12">
                    <div class="iq-card">
                        <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title">
                                <h4 class="card-title">图像展示</h4>
                            </div>
                        </div>
                        <div class="iq-card-body">
                            <div class="row">
                                    <div
                                            id="nifti-image2"
                                            style="width: 900px; height: 400px"
                                    ></div>
                      
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Wrapper END -->
<!-- Footer -->
<div th:replace="~{commons/commons::footer}"></div>
<!-- Footer END -->
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->

<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<div th:replace="~{commons/commons::js}"></div>

<script src="js/cornerstone/cornerstone.js"></script>
<script src="js/cornerstone/cornerstoneMath.js"></script>
<script src="js/cornerstone/hammer.js"></script>
<script src="js/cornerstone/cornerstoneTools.js"></script>
<script src="js/cornerstone/cornerstoneFileImageLoader.js"></script>
<script src="js/cornerstone/cornerstoneNIFTIImageLoader.js"></script>
<script>
    cornerstoneNIFTIImageLoader.external.cornerstone = cornerstone;
    const ImageId = cornerstoneNIFTIImageLoader.nifti.ImageId;
    let loaded = false;

    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const niftiName = urlParams.get('imageId');
        downloadAndView(niftiName);
    };

    const element2 = document.getElementById('nifti-image2');
    cornerstone.enable(element2);
    
    function downloadAndView(niftiName) {
        let url = `/Files/${niftiName}`;

        loadAndViewImage(`nifti:${url}`);
    }

    function loadAndViewImage(imageId) {
        const element2 = document.getElementById('nifti-image2');
        const imageIdObject = ImageId.fromURL(imageId);

        try {
            cornerstone.loadAndCacheImage(imageIdObject.url).then(function (image) {
                console.log(image);
                const numberOfSlices = cornerstone.metaData.get('multiFrameModule', imageIdObject.url).numberOfFrames;
                const stack = {
                    currentImageIdIndex: imageIdObject.slice.index,
                    imageIds: Array.from(Array(numberOfSlices), (_, i) => `nifti:${imageIdObject.filePath}#${imageIdObject.slice.dimension}-${i}`)
                };

                const viewport = cornerstone.getDefaultViewportForImage(element2, image);
                cornerstone.displayImage(element2, image, viewport);
                if (loaded === false) {
                    cornerstoneTools.addStackStateManager(element2, ['stack', 'wwwc', 'pan', 'zoom']);
                    cornerstoneTools.addToolState(element2, 'stack', stack);
                    cornerstoneTools.mouseInput.enable(element2);
                    cornerstoneTools.mouseWheelInput.enable(element2);
                    cornerstoneTools.wwwc.activate(element2, 1);
                    cornerstoneTools.pan.activate(element2, 2);
                    cornerstoneTools.zoom.activate(element2, 4);
                    cornerstoneTools.stackScrollWheel.activate(element2);
                    cornerstoneTools.orientationMarkers.enable(element2);

                    loaded = true;
                }

            }, function (err) {
                alert(err);
                console.error(err);
            });
        } catch (err) {
            alert(err);
            console.error(err);
        }
    }


</script>
</body>
</html>